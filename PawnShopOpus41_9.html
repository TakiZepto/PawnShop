<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pawn Shop Merge & Go</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .phone-container {
            width: 1080px;
            height: 2100px;
            background: #2c2c2c;
            border-radius: 40px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            transform: scale(0.42);
            transform-origin: center;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-title {
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .coin-display {
            background: #ffd700;
            color: #2c2c2c;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 36px;
            font-weight: bold;
            display: inline-block;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }

        .upper-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            height: 600px;
        }

        .generator-section {
            width: 30%;
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .box-level-display {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .carton-box {
            width: 200px;
            height: 200px;
            background: linear-gradient(145deg, #8B4513, #D2691E);
            border: 5px solid #654321;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .carton-box.silver {
            background: linear-gradient(145deg, #C0C0C0, #A0A0A0);
            border-color: #808080;
        }

        .carton-box.upgraded {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-color: #FF8C00;
        }

        .carton-box:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }

        .carton-box:active {
            transform: scale(0.95);
        }

        .assistant-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #555;
        }

        .assistant-display {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .buy-button, .upgrade-button, .assistant-button {
            margin-top: 15px;
            padding: 12px 25px;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .buy-button {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            box-shadow: 0 4px 15px rgba(76,175,80,0.4);
        }

        .upgrade-button {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2);
            box-shadow: 0 4px 15px rgba(156,39,176,0.4);
        }

        .assistant-button {
            background: linear-gradient(145deg, #4ecdc4, #44a3aa);
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
            font-size: 24px;
        }

        .buy-button:hover:not(:disabled), 
        .upgrade-button:hover:not(:disabled),
        .assistant-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .buy-button:disabled, 
        .upgrade-button:disabled,
        .assistant-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pawn-section {
            width: 70%;
            background: linear-gradient(145deg, #4a4a4a, #5a5a5a);
            border-radius: 20px;
            padding: 30px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .pawn-title {
            color: #ffd700;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .pawn-table {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            height: 350px;
            overflow-y: auto;
        }

        .vip-section {
            margin-top: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }

        .vip-title {
            color: #2c2c2c;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .vip-slot {
            background: linear-gradient(145deg, #fff, #f0f0f0);
            border: 3px solid #FFD700;
            border-radius: 15px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .vip-request {
            text-align: center;
            color: #2c2c2c;
            font-size: 20px;
            font-weight: bold;
        }

        .vip-reward {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
        }

        .vip-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .pawn-slot {
            background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
            border: 3px dashed #666;
            border-radius: 15px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }

        .pawn-slot .drag-hint {
            color: #888;
            font-size: 18px;
            text-align: center;
            padding: 10px;
        }

        .pawn-slot.occupied {
            border-color: #ffd700;
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a);
        }

        .pawn-slot.occupied .drag-hint {
            display: none;
        }

        .pawn-slot.selling {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pawn-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
        }

        .pawn-value {
            position: absolute;
            bottom: 10px;
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 24px;
        }

        .merge-board {
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a);
            border-radius: 20px;
            padding: 30px;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            min-height: 800px;
        }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 6/8;
            position: relative;
        }

        .grid-cell {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border: 2px solid #444;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }

        .grid-cell.locked {
            visibility: hidden;
        }

        .section-lock {
            position: absolute;
            grid-column: span 6;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border: 3px solid #666;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .section-lock.section-1 {
            grid-row: 3 / 5;
            grid-column: 1 / 7;
        }

        .section-lock.section-2 {
            grid-row: 5 / 7;
            grid-column: 1 / 7;
        }

        .section-lock.section-3 {
            grid-row: 7 / 9;
            grid-column: 1 / 7;
        }

        .unlock-button {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: #2c2c2c;
            padding: 20px 40px;
            border: none;
            border-radius: 50px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }

        .unlock-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255,215,0,0.6);
        }

        .unlock-button:disabled {
            background: linear-gradient(145deg, #555, #333);
            color: #888;
            cursor: not-allowed;
        }

        .lock-message {
            color: #888;
            font-size: 20px;
            margin-top: 15px;
            text-align: center;
        }

        .grid-cell.highlight {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .merge-item {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
            cursor: grab;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .merge-item:active {
            cursor: grabbing;
        }

        .merge-item.dragging {
            opacity: 0.5;
        }

        .merge-item.family-1 { background: linear-gradient(145deg, #ff6b6b, #ff5252); }
        .merge-item.family-2 { background: linear-gradient(145deg, #4ecdc4, #44a3aa); }
        .merge-item.family-3 { background: linear-gradient(145deg, #95e77e, #7bc862); }

        .merge-animation {
            animation: mergeEffect 0.5s ease-out;
        }

        @keyframes mergeEffect {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .coin-animation {
            position: fixed;
            color: #ffd700;
            font-size: 48px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .lucky-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            z-index: 2000;
            animation: luckyPop 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes luckyPop {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-100px) scale(1.5);
            }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="game-header">
            <div class="game-title">Pawn Shop Merge & Go</div>
            <div class="coin-display">üí∞ <span id="coins">300</span></div>
        </div>

        <div class="upper-section">
            <div class="generator-section">
                <div class="assistant-section">
                    <div class="assistant-display">ü§ñ Assistant Level: <span id="assistantLevel">0</span></div>
                    <button class="assistant-button" id="assistantButton">Hire Assistant - <span id="assistantCost">3000</span>üí∞</button>
                </div>
                <button class="upgrade-button" id="upgradeButton">Upgrade Box - <span id="upgradeCost">1000</span>üí∞</button>
                <div class="box-level-display">Box Level: <span id="boxLevel">0</span></div>
                <div class="carton-box" id="cartonBox">üì¶</div>
                <button class="buy-button" id="buyButton">Buy Box - 100üí∞</button>
            </div>

            <div class="pawn-section">
                <div class="pawn-title">üè™ Pawn Shop</div>
                <div class="vip-section">
                    <div class="vip-title">üëë VIP Client</div>
                    <div class="vip-slot" id="vipSlot">
                        <div class="vip-request">Waiting for VIP...</div>
                    </div>
                </div>
                <div class="pawn-table" id="pawnTable">
                    <!-- Pawn slots will be generated here -->
                </div>
            </div>
        </div>

        <div class="merge-board">
            <div class="board-grid" id="boardGrid">
                <!-- Grid cells will be generated here -->
            </div>
        </div>
    </div>

    <script>
        class PawnShopMergeGame {
            constructor() {
                this.coins = 300;
                this.boardWidth = 6;
                this.boardHeight = 8;
                this.families = ['family-1', 'family-2', 'family-3'];
                this.board = Array(this.boardWidth * this.boardHeight).fill(null);
                this.pawnSlots = [];
                this.draggedItem = null;
                this.draggedFromIndex = null;
                this.boxLevel = 0;
                this.maxBoxLevel = 15;
                this.assistantLevel = 0;
                this.maxAssistantLevel = 5;
                this.autoMergeTimer = null;
                this.vipClient = null;
                this.vipTimer = null;
                
                // Section management
                this.unlockedSections = [0]; // Start with only first section unlocked (rows 0-1)
                this.sectionCosts = [0, 1000, 4000, 10000]; // Cost for each section (0 is free/already unlocked)
                
                this.itemValues = {
                    1: 50,
                    2: 130,
                    3: 340,
                    4: 880,
                    5: 2300,
                    6: 6000,
                    7: 15600,
                    8: 40500,
                    9: 105000,
                    10: 275000
                };

                this.sellTimes = {
                    1: 5000,
                    2: 4500,
                    3: 4000,
                    4: 3500,
                    5: 3000,
                    6: 2500,
                    7: 2000,
                    8: 1500,
                    9: 1000,
                    10: 1000
                };

                this.init();
            }

            init() {
                this.createBoard();
                this.createPawnSlots();
                this.setupEventListeners();
                this.updateCoinDisplay();
                this.updateBoxDisplay();
                this.updateAssistantDisplay();
            }

            getSectionFromIndex(index) {
                const row = Math.floor(index / this.boardWidth);
                return Math.floor(row / 2); // Each section is 2 rows
            }

            isCellUnlocked(index) {
                const section = this.getSectionFromIndex(index);
                return this.unlockedSections.includes(section);
            }

            createBoard() {
                const boardGrid = document.getElementById('boardGrid');
                boardGrid.innerHTML = '';
                
                // Create all grid cells
                for (let i = 0; i < this.boardWidth * this.boardHeight; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    // Lock cells that are in locked sections
                    if (!this.isCellUnlocked(i)) {
                        cell.classList.add('locked');
                    }
                    
                    cell.dataset.index = i;
                    
                    cell.addEventListener('dragover', (e) => this.handleDragOver(e));
                    cell.addEventListener('drop', (e) => this.handleDrop(e));
                    cell.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    cell.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    
                    boardGrid.appendChild(cell);
                }
                
                // Create section locks for locked sections
                for (let section = 1; section < 4; section++) {
                    if (!this.unlockedSections.includes(section)) {
                        this.createSectionLock(section);
                    }
                }
            }

            createSectionLock(section) {
                const boardGrid = document.getElementById('boardGrid');
                const lockDiv = document.createElement('div');
                lockDiv.className = `section-lock section-${section}`;
                lockDiv.dataset.section = section;
                
                const canUnlock = this.unlockedSections.includes(section - 1);
                const cost = this.sectionCosts[section];
                
                if (canUnlock) {
                    lockDiv.innerHTML = `
                        <button class="unlock-button" ${this.coins < cost ? 'disabled' : ''}>
                            üîì Unlock Section ${section + 1}<br>
                            üí∞ ${cost}
                        </button>
                    `;
                    
                    const button = lockDiv.querySelector('.unlock-button');
                    button.addEventListener('click', () => this.unlockSection(section));
                } else {
                    lockDiv.innerHTML = `
                        <button class="unlock-button" disabled>
                            üîí Section ${section + 1}
                        </button>
                        <div class="lock-message">Purchase previous sections to access</div>
                    `;
                }
                
                boardGrid.appendChild(lockDiv);
            }

            unlockSection(section) {
                const cost = this.sectionCosts[section];
                
                if (this.coins < cost) {
                    this.showMessage('Not enough coins to unlock this section!');
                    return;
                }
                
                if (!this.unlockedSections.includes(section - 1)) {
                    this.showMessage('Unlock previous sections first!');
                    return;
                }
                
                // Deduct coins and unlock section
                this.coins -= cost;
                this.unlockedSections.push(section);
                this.updateCoinDisplay();
                
                // Remove the lock overlay
                const lockDiv = document.querySelector(`.section-lock.section-${section}`);
                if (lockDiv) {
                    lockDiv.remove();
                }
                
                // Unlock the cells in this section
                const startRow = section * 2;
                const endRow = startRow + 2;
                for (let row = startRow; row < endRow; row++) {
                    for (let col = 0; col < this.boardWidth; col++) {
                        const index = row * this.boardWidth + col;
                        const cell = document.querySelector(`.grid-cell[data-index="${index}"]`);
                        if (cell) {
                            cell.classList.remove('locked');
                        }
                    }
                }
                
                // Update next section lock if it exists
                if (section < 3) {
                    const nextLockDiv = document.querySelector(`.section-lock.section-${section + 1}`);
                    if (nextLockDiv) {
                        nextLockDiv.remove();
                        this.createSectionLock(section + 1);
                    }
                }
                
                this.showLuckyMessage(`Section ${section + 1} Unlocked!`);
            }

            createPawnSlots() {
                const pawnTable = document.getElementById('pawnTable');
                pawnTable.innerHTML = '';
                
                // Create 3 regular pawn slots
                for (let i = 0; i < 3; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'pawn-slot';
                    slot.dataset.slotIndex = i;
                    slot.innerHTML = '<div class="drag-hint">Drag your<br>item here</div>';
                    
                    slot.addEventListener('dragover', (e) => this.handlePawnDragOver(e));
                    slot.addEventListener('drop', (e) => this.handlePawnDrop(e));
                    
                    pawnTable.appendChild(slot);
                    this.pawnSlots.push({ element: slot, item: null, timer: null });
                }
                
                // Start VIP client timer
                this.scheduleNextVIP();
            }

            setupEventListeners() {
                document.getElementById('buyButton').addEventListener('click', () => this.buyItem());
                document.getElementById('upgradeButton').addEventListener('click', () => this.upgradeBox());
                document.getElementById('assistantButton').addEventListener('click', () => this.upgradeAssistant());
                
                // VIP slot events
                const vipSlot = document.getElementById('vipSlot');
                vipSlot.addEventListener('dragover', (e) => this.handleVIPDragOver(e));
                vipSlot.addEventListener('drop', (e) => this.handleVIPDrop(e));
            }

            getAssistantCost() {
                return 3000 + (3000 * this.assistantLevel);
            }

            getAutoMergeInterval() {
                if (this.assistantLevel === 0) return null;
                const intervals = [3000, 2000, 1000, 500, 500];
                return intervals[this.assistantLevel - 1];
            }

            upgradeAssistant() {
                if (this.assistantLevel >= this.maxAssistantLevel) {
                    this.showMessage('Assistant is at maximum level!');
                    return;
                }

                const cost = this.getAssistantCost();
                if (this.coins < cost) {
                    this.showMessage('Not enough coins for assistant!');
                    return;
                }

                this.coins -= cost;
                this.assistantLevel++;
                this.updateCoinDisplay();
                this.updateAssistantDisplay();
                
                this.startAutoMerge();
                
                this.showMessage(`Assistant Level ${this.assistantLevel}!`);
            }

            updateAssistantDisplay() {
                document.getElementById('assistantLevel').textContent = this.assistantLevel;
                const assistantButton = document.getElementById('assistantButton');
                
                if (this.assistantLevel >= this.maxAssistantLevel) {
                    assistantButton.innerHTML = 'ü§ñ Max Level';
                    assistantButton.disabled = true;
                } else {
                    const nextCost = this.getAssistantCost();
                    assistantButton.innerHTML = `Hire Assistant - <span id="assistantCost">${nextCost}</span>üí∞`;
                    assistantButton.disabled = this.coins < nextCost;
                }
            }

            startAutoMerge() {
                if (this.autoMergeTimer) {
                    clearInterval(this.autoMergeTimer);
                }
                
                const interval = this.getAutoMergeInterval();
                if (interval) {
                    this.autoMergeTimer = setInterval(() => this.performAutoMerge(), interval);
                }
            }

            performAutoMerge() {
                const merges = [];
                
                for (let i = 0; i < this.board.length; i++) {
                    if (!this.board[i] || !this.isCellUnlocked(i)) continue;
                    
                    for (let j = i + 1; j < this.board.length; j++) {
                        if (!this.board[j] || !this.isCellUnlocked(j)) continue;
                        
                        if (this.board[i].family === this.board[j].family && 
                            this.board[i].level === this.board[j].level) {
                            merges.push({ from: i, to: j, level: this.board[i].level });
                        }
                    }
                }
                
                if (merges.length > 0) {
                    const merge = merges[Math.floor(Math.random() * merges.length)];
                    this.mergeItems(merge.from, merge.to);
                    
                    const cell = document.querySelector(`.grid-cell[data-index="${merge.to}"]`);
                    cell.style.boxShadow = '0 0 30px #4ecdc4';
                    setTimeout(() => {
                        cell.style.boxShadow = '';
                    }, 500);
                }
            }

            scheduleNextVIP() {
                const delay = 15000 + Math.random() * 15000;
                setTimeout(() => this.createVIPClient(), delay);
            }

            createVIPClient() {
                if (this.vipClient) return;
                
                let minLevel = 3;
                let maxLevel = 5;
                
                if (this.boxLevel >= 11) {
                    minLevel = 5;
                    maxLevel = 7;
                } else if (this.boxLevel >= 6) {
                    minLevel = 4;
                    maxLevel = 6;
                }
                
                const requestedLevel = minLevel + Math.floor(Math.random() * (maxLevel - minLevel + 1));
                const requestedFamily = this.families[Math.floor(Math.random() * this.families.length)];
                const reward = this.itemValues[requestedLevel] * 2;
                
                this.vipClient = {
                    level: requestedLevel,
                    family: requestedFamily,
                    reward: reward,
                    timeLeft: 30000
                };
                
                this.updateVIPDisplay();
                this.startVIPTimer();
            }

            updateVIPDisplay() {
                const vipSlot = document.getElementById('vipSlot');
                
                if (!this.vipClient) {
                    vipSlot.innerHTML = '<div class="vip-request">Waiting for VIP...</div>';
                    return;
                }
                
                vipSlot.innerHTML = `
                    <div class="vip-request">
                        Wants Level ${this.vipClient.level}
                        <div class="merge-item ${this.vipClient.family}" style="width: 60px; height: 60px; font-size: 28px; margin: 10px auto;">
                            ${this.vipClient.level}
                        </div>
                    </div>
                    <div class="vip-reward">Reward: üí∞${this.vipClient.reward}</div>
                    <div class="vip-timer" id="vipTimer"></div>
                `;
            }

            startVIPTimer() {
                if (this.vipTimer) clearInterval(this.vipTimer);
                
                const updateTimer = () => {
                    if (!this.vipClient) return;
                    
                    this.vipClient.timeLeft -= 100;
                    const seconds = Math.ceil(this.vipClient.timeLeft / 1000);
                    
                    const timerElement = document.getElementById('vipTimer');
                    if (timerElement) {
                        timerElement.textContent = `${seconds}s`;
                    }
                    
                    if (this.vipClient.timeLeft <= 0) {
                        clearInterval(this.vipTimer);
                        this.vipClient = null;
                        this.updateVIPDisplay();
                        this.scheduleNextVIP();
                    }
                };
                
                this.vipTimer = setInterval(updateTimer, 100);
            }

            handleVIPDragOver(e) {
                e.preventDefault();
            }

            handleVIPDrop(e) {
                e.preventDefault();
                
                if (!this.vipClient || !this.draggedItem) return;
                
                if (this.draggedItem.level === this.vipClient.level && 
                    this.draggedItem.family === this.vipClient.family) {
                    
                    this.coins += this.vipClient.reward;
                    this.updateCoinDisplay();
                    this.showCoinAnimation(e.target, `+${this.vipClient.reward}`);
                    this.showLuckyMessage('VIP Satisfied!');
                    
                    this.board[this.draggedFromIndex] = null;
                    this.renderItem(this.draggedFromIndex);
                    
                    clearInterval(this.vipTimer);
                    this.vipClient = null;
                    this.updateVIPDisplay();
                    this.scheduleNextVIP();
                } else {
                    this.showMessage('Wrong item for VIP!');
                }
            }

            getUpgradeCost() {
                return 1000 + (1000 * this.boxLevel);
            }

            upgradeBox() {
                if (this.boxLevel >= this.maxBoxLevel) {
                    this.showMessage('Box is at maximum level!');
                    return;
                }

                const cost = this.getUpgradeCost();
                if (this.coins < cost) {
                    this.showMessage('Not enough coins to upgrade!');
                    return;
                }

                this.coins -= cost;
                this.boxLevel++;
                this.updateCoinDisplay();
                this.updateBoxDisplay();
                
                const box = document.getElementById('cartonBox');
                box.style.transform = 'scale(1.3) rotate(360deg)';
                setTimeout(() => {
                    box.style.transform = '';
                }, 500);
                
                if (this.boxLevel === 6) {
                    this.showLuckyMessage('Level 3 Items Unlocked!');
                } else if (this.boxLevel === 11) {
                    this.showLuckyMessage('Level 4 Items Unlocked!');
                }
            }

            updateBoxDisplay() {
                document.getElementById('boxLevel').textContent = this.boxLevel;
                const upgradeButton = document.getElementById('upgradeButton');
                
                if (this.boxLevel >= this.maxBoxLevel) {
                    upgradeButton.innerHTML = 'Max Level';
                    upgradeButton.disabled = true;
                } else {
                    const nextCost = this.getUpgradeCost();
                    upgradeButton.innerHTML = `Upgrade Box - <span id="upgradeCost">${nextCost}</span>üí∞`;
                    upgradeButton.disabled = this.coins < nextCost;
                }
                
                const box = document.getElementById('cartonBox');
                box.classList.remove('upgraded', 'silver');
                if (this.boxLevel >= 6 && this.boxLevel < 11) {
                    box.classList.add('silver');
                } else if (this.boxLevel >= 11) {
                    box.classList.add('upgraded');
                }
            }

            getRandomItemLevel() {
                const weights = [];
                
                weights.push({ level: 1, weight: 10 });
                
                if (this.boxLevel > 0) {
                    const level2Weight = Math.min(this.boxLevel * 2, 10);
                    weights.push({ level: 2, weight: level2Weight });
                }
                
                if (this.boxLevel >= 6) {
                    const level3Weight = Math.min((this.boxLevel - 5) * 2, 10);
                    weights.push({ level: 3, weight: level3Weight });
                }
                
                if (this.boxLevel >= 11) {
                    const level4Weight = Math.min((this.boxLevel - 10) * 2, 10);
                    weights.push({ level: 4, weight: level4Weight });
                }
                
                const totalWeight = weights.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                
                for (const item of weights) {
                    random -= item.weight;
                    if (random <= 0) {
                        return item.level;
                    }
                }
                
                return 1;
            }

            getItemCount() {
                const random = Math.random();
                if (random < 0.7) {
                    return 3;
                } else if (random < 0.9) {
                    return 4;
                } else {
                    return 5;
                }
            }

            buyItem() {
                if (this.coins < 100) {
                    this.showMessage('Not enough coins!');
                    return;
                }

                const itemCount = this.getItemCount();
                
                // Find empty spaces only in unlocked sections
                const emptyIndices = [];
                for (let i = 0; i < this.board.length && emptyIndices.length < itemCount; i++) {
                    if (this.board[i] === null && this.isCellUnlocked(i)) {
                        emptyIndices.push(i);
                    }
                }
                
                if (emptyIndices.length < itemCount) {
                    this.showMessage('Not enough space! Clear some items or unlock more sections.');
                    return;
                }

                this.coins -= 100;
                this.updateCoinDisplay();

                if (itemCount === 4) {
                    this.showLuckyMessage('Lucky!');
                } else if (itemCount === 5) {
                    this.showLuckyMessage('Super Lucky!');
                }

                for (let i = 0; i < itemCount; i++) {
                    const boardIndex = emptyIndices[i];
                    const family = this.families[Math.floor(Math.random() * this.families.length)];
                    const level = this.getRandomItemLevel();
                    
                    setTimeout(() => {
                        this.addItemToBoard(boardIndex, family, level);
                    }, i * 100);
                }
                
                const box = document.getElementById('cartonBox');
                box.style.transform = 'scale(1.2) rotate(10deg)';
                setTimeout(() => {
                    box.style.transform = '';
                }, 300);
            }

            addItemToBoard(index, family, level) {
                this.board[index] = { family, level };
                this.renderItem(index);
            }

            renderItem(index) {
                const cell = document.querySelector(`.grid-cell[data-index="${index}"]`);
                const item = this.board[index];
                
                if (!item) {
                    cell.innerHTML = '';
                    return;
                }

                const itemElement = document.createElement('div');
                itemElement.className = `merge-item ${item.family}`;
                itemElement.draggable = true;
                itemElement.textContent = item.level;
                itemElement.dataset.index = index;
                
                itemElement.addEventListener('dragstart', (e) => this.handleDragStart(e));
                itemElement.addEventListener('dragend', (e) => this.handleDragEnd(e));
                
                cell.innerHTML = '';
                cell.appendChild(itemElement);
            }

            handleDragStart(e) {
                const index = parseInt(e.target.dataset.index);
                this.draggedItem = this.board[index];
                this.draggedFromIndex = index;
                e.target.classList.add('dragging');
            }

            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('highlight');
                });
            }

            handleDragOver(e) {
                e.preventDefault();
            }

            handleDragEnter(e) {
                if (e.target.classList.contains('grid-cell') && !e.target.classList.contains('locked')) {
                    e.target.classList.add('highlight');
                }
            }

            handleDragLeave(e) {
                if (e.target.classList.contains('grid-cell')) {
                    e.target.classList.remove('highlight');
                }
            }

            handleDrop(e) {
                e.preventDefault();
                const targetCell = e.target.closest('.grid-cell');
                if (!targetCell || targetCell.classList.contains('locked')) return;

                const targetIndex = parseInt(targetCell.dataset.index);
                
                // Prevent dropping in locked sections
                if (!this.isCellUnlocked(targetIndex)) {
                    this.showMessage('This section is locked!');
                    return;
                }
                
                const targetItem = this.board[targetIndex];

                if (targetItem && targetItem.family === this.draggedItem.family && 
                    targetItem.level === this.draggedItem.level && 
                    targetIndex !== this.draggedFromIndex) {
                    this.mergeItems(this.draggedFromIndex, targetIndex);
                } else if (!targetItem) {
                    this.board[targetIndex] = this.draggedItem;
                    this.board[this.draggedFromIndex] = null;
                    this.renderItem(this.draggedFromIndex);
                    this.renderItem(targetIndex);
                }

                targetCell.classList.remove('highlight');
            }

            handlePawnDragOver(e) {
                e.preventDefault();
            }

            handlePawnDrop(e) {
                e.preventDefault();
                const slot = e.target.closest('.pawn-slot');
                if (!slot) return;

                const slotIndex = parseInt(slot.dataset.slotIndex);
                const pawnSlot = this.pawnSlots[slotIndex];

                if (!pawnSlot.item) {
                    pawnSlot.item = this.draggedItem;
                    this.board[this.draggedFromIndex] = null;
                    this.renderItem(this.draggedFromIndex);
                    this.renderPawnItem(slotIndex);
                    this.startSellTimer(slotIndex);
                }
            }

            renderPawnItem(slotIndex) {
                const pawnSlot = this.pawnSlots[slotIndex];
                const slot = pawnSlot.element;
                
                if (!pawnSlot.item) {
                    slot.innerHTML = '<div class="drag-hint">Drag your<br>item here</div>';
                    slot.classList.remove('occupied');
                    return;
                }

                slot.classList.add('occupied');
                slot.innerHTML = `
                    <div class="merge-item ${pawnSlot.item.family}" style="width: 100px; height: 100px; font-size: 48px;">
                        ${pawnSlot.item.level}
                    </div>
                    <div class="pawn-timer" id="timer-${slotIndex}"></div>
                    <div class="pawn-value">üí∞${this.itemValues[pawnSlot.item.level]}</div>
                `;
            }

            startSellTimer(slotIndex) {
                const pawnSlot = this.pawnSlots[slotIndex];
                const sellTime = this.sellTimes[pawnSlot.item.level];
                let timeLeft = sellTime;

                pawnSlot.element.classList.add('selling');

                const updateTimer = () => {
                    const seconds = Math.ceil(timeLeft / 1000);
                    const timerElement = document.getElementById(`timer-${slotIndex}`);
                    if (timerElement) {
                        timerElement.textContent = `${seconds}s`;
                    }
                    timeLeft -= 100;

                    if (timeLeft <= 0) {
                        this.sellItem(slotIndex);
                    } else {
                        pawnSlot.timer = setTimeout(updateTimer, 100);
                    }
                };

                updateTimer();
            }

            sellItem(slotIndex) {
                const pawnSlot = this.pawnSlots[slotIndex];
                const value = this.itemValues[pawnSlot.item.level];
                
                this.coins += value;
                this.updateCoinDisplay();
                this.showCoinAnimation(pawnSlot.element, `+${value}`);
                
                pawnSlot.element.classList.remove('selling');
                pawnSlot.item = null;
                pawnSlot.timer = null;
                this.renderPawnItem(slotIndex);
            }

            mergeItems(fromIndex, toIndex) {
                const newLevel = this.board[toIndex].level + 1;
                const family = this.board[toIndex].family;
                
                this.board[toIndex] = { family, level: newLevel };
                this.board[fromIndex] = null;
                
                this.renderItem(fromIndex);
                this.renderItem(toIndex);
                
                const targetCell = document.querySelector(`.grid-cell[data-index="${toIndex}"] .merge-item`);
                targetCell.classList.add('merge-animation');
                setTimeout(() => {
                    targetCell.classList.remove('merge-animation');
                }, 500);
            }

            updateCoinDisplay() {
                document.getElementById('coins').textContent = this.coins;
                const buyButton = document.getElementById('buyButton');
                buyButton.disabled = this.coins < 100;
                
                const upgradeButton = document.getElementById('upgradeButton');
                if (this.boxLevel < this.maxBoxLevel) {
                    upgradeButton.disabled = this.coins < this.getUpgradeCost();
                }
                
                const assistantButton = document.getElementById('assistantButton');
                if (this.assistantLevel < this.maxAssistantLevel) {
                    assistantButton.disabled = this.coins < this.getAssistantCost();
                }
                
                // Update section unlock buttons
                for (let section = 1; section < 4; section++) {
                    if (this.unlockedSections.includes(section - 1) && !this.unlockedSections.includes(section)) {
                        const button = document.querySelector(`.section-lock.section-${section} .unlock-button`);
                        if (button) {
                            button.disabled = this.coins < this.sectionCosts[section];
                        }
                    }
                }
            }

            showCoinAnimation(element, text) {
                const rect = element.getBoundingClientRect();
                const coin = document.createElement('div');
                coin.className = 'coin-animation';
                coin.textContent = text;
                coin.style.left = rect.left + rect.width / 2 + 'px';
                coin.style.top = rect.top + 'px';
                document.body.appendChild(coin);
                
                setTimeout(() => coin.remove(), 1500);
            }

            showLuckyMessage(text) {
                const message = document.createElement('div');
                message.className = 'lucky-message';
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => message.remove(), 1500);
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.className = 'game-message';
                message.textContent = text;
                message.style.cssText = `
                    position: fixed;
                    top: 40%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 20px;
                    font-size: 36px;
                    font-weight: bold;
                    z-index: 2000;
                    animation: fadeInOut 2s ease-out forwards;
                    pointer-events: none;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                    }
                `;
                if (!document.querySelector('style[data-game-message]')) {
                    style.setAttribute('data-game-message', 'true');
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 2000);
            }
        }

        // Start the game
        const game = new PawnShopMergeGame();
    </script>
</body>
</html>